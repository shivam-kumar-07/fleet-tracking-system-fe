name: Deploy Frontend to EC2

on:
  push:
    branches:
      - main

env:
  NODE_VERSION: 20.17.0

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js App
        run: npm run build

      - name: Prepare deploy folder
        run: |
          echo "Preparing clean deploy folder..."

          rm -rf deploy || true
          mkdir deploy

          # Copy .next
          cp -a .next deploy/.next

          # Copy public folder ONLY if it exists
          if [ -d public ]; then
            echo "public folder found — copying..."
            cp -a public deploy/public
          else
            echo "public folder NOT found — skipping..."
          fi

          # Copy required files
          cp -a package.json deploy/package.json
          cp -a package-lock.json deploy/package-lock.json
          cp -a next.config.js deploy/next.config.js

          echo "Deploy folder built:"
          ls -la deploy

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fe-build
          path: deploy

  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: fe-build
          path: deploy

      - name: Install SSH + rsync
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync openssh-client tree

      - name: Configure SSH (Debug Enabled)
        run: |
          echo "===== STEP 1: Creating ~/.ssh directory ====="
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ls -ld ~/.ssh

          echo "===== STEP 2: Writing SSH key to id_rsa ====="
          printf "%s" "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa

          echo "===== STEP 3: Checking id_rsa file ====="
          if [ ! -f ~/.ssh/id_rsa ]; then
            echo "ERROR: id_rsa file was NOT created!"
            exit 1
          fi

          echo "===== STEP 4: Permissions for id_rsa ====="
          chmod 600 ~/.ssh/id_rsa
          ls -l ~/.ssh/id_rsa

          echo "===== STEP 5: Checking id_rsa size (should NOT be 0 bytes) ====="
          FILESIZE=$(stat -c%s ~/.ssh/id_rsa)
          echo "id_rsa file size = $FILESIZE bytes"
          if [ "$FILESIZE" -lt 100 ]; then
            echo "ERROR: SSH key is too small → key is corrupted or empty"
            exit 1
          fi

          echo "===== STEP 6: Running SSH key syntax validation ====="
          ssh-keygen -l -f ~/.ssh/id_rsa || echo "WARNING: ssh-keygen cannot read key (may be encrypted or invalid)"

          echo "===== STEP 7: Adding EC2 host to known_hosts ====="
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts || {
            echo "ERROR: ssh-keyscan failed!"
            exit 1
          }

          echo "===== STEP 8: Final check of ~/.ssh contents ====="
          ls -la ~/.ssh

          echo "SSH configuration completed successfully."

      - name: Deploy to EC2
        env:
          RSYNC_RSH: "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no"
        run: |
          echo "Deploying to EC2..."

          # Completely sync deploy folder → directly into /var/www/fleet-fe
          rsync -avz --delete \
            deploy/ \
            ${{ secrets.SSH_USER }}@${{ secrets.EC2_HOST }}:${{ secrets.DEPLOY_DIR }}/

      - name: Restart Frontend App
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          
            cd "${{ secrets.DEPLOY_DIR }}"

            echo "Writing .env file..."
            echo "${{ secrets.FE_ENV }}" > .env

            echo "Install production node_modules"
            npm install --production

            echo "Restarting PM2 service"
            pm2 stop fleet-fe || true
            pm2 delete fleet-fe || true
            pm2 start npm --name "fleet-fe" -- start

            pm2 save
            pm2 status

            exit
          EOF
